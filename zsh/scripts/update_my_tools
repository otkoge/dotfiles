# All the needed tools

function is_installed { 
    if [[ $1 == "python3-pip" ]]; then
        which pip3 &> /dev/null
    else
        which $1 &> /dev/null 
    fi
}

function install {
    is_installed $1
    if [ $? -ne 0 ]; then
        echo "Installing: ${1}..."
        sudo apt install $1
    else
        echo "Already installed: ${1}"
    fi
}

function update_lsd {
    VERSION=$(curl -s -L -H "Accept: application/json" https://github.com/Peltoche/lsd/releases/latest | jq -r '.tag_name')
    is_installed lsd
    if [ $? -ne 0 ] || [ "$(lsd --version | cut -d" " -f2)" != "$VERSION" ]; then
        echo "Updating lsd ${VERSION}"
        TMP_FILE="$(mktemp)"
        wget "https://github.com/Peltoche/lsd/releases/download/${VERSION}/lsd_${VERSION}_amd64.deb" -O $TMP_FILE
        sudo dpkg -i "$TMP_FILE"
        rm -f "${TMP_FILE}"
    else
        echo "lsd is already latest version"
    fi

}

function update_go {
    VERSION=$(curl -s https://golang.org/doc/install | grep goVersion | cut -d'"' -f2)
    is_installed "go"
    if [ $? -eq 0 ] && [[ "$(go version | cut -d" " -f3)" == "$VERSION" ]]; then
        echo "${VERSION} is already installed"
    else
        echo "Updating ($VERSION)"
        TMP_FILE="$(mktemp)"
        curl -o $TMP_FILE -L "https://golang.org/dl/${VERSION}.linux-amd64.tar.gz"
        sudo rm -rf /usr/local/go && sudo tar -C /usr/local -xzf "${TMP_FILE}"
        sudo rm "${TMP_FILE}"
    fi
}

function update_nvim {
    if [ ! -d ~/.local/bin/ ]; then
        mkdir -p ~/.local/bin/
    fi
    VERSION=$(curl -s -L -H "Accept: application/json" https://github.com/neovim/neovim/releases/nightly | jq -r '.tag_name')
    is_installed "nvim"
    if [ $? -eq 0 ] && [[ "$(nvim --version | head -1 | cut -d" " -f2)" == $VERSION ]]; then 
        echo "nvim already at latest version" 
    else
        echo "Updating Neovim ${VERSION}"
        rm -f ~/.local/bin/nvim
        curl -L -o ~/.local/bin/nvim https://github.com/neovim/neovim/releases/download/nightly/nvim.appimage
        chmod u+x ~/.local/bin/nvim
    fi
}

function install_base_tools {
    install jq
    install git
    install zsh
    install curl
    install python3-pip
    update_go
    update_lsd
    update_nvim
}

